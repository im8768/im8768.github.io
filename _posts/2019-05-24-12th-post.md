

10.3 자바 서비스 구현

10.3.1 알람 매니저 서비스의 구조 분석

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/58284200-0bc5b580-7de5-11e9-89cd-dcec686cc18b.jpg">
</div>

- 알람 매니저 서비스 구현 방식

  네이티브 시스템 서비스를 구현하려면 서비스 인터페이스, 서비스 프록시, 서비스 스텁, 서비스를 개발자가 모두 구현해야 하지만 자바 시스템 서비스를 구현할 때는 AIDL을 이용해 자동으로 생성할 수 있다.

```
//알람 매니저 서비스 코드
package android.app;
import android.ap.PendingIntent;

interface IAlarmManager {
   void set(int type, long triggerAtTime, in pendingIntent operation);
   void setRepeating(int type, long triggerAtTime, in pendingIntent operation);
   void setInexactRepeating(int type, long triggerAtTime, in pendingIntent operation);
   void setTimeZone(String zone);
   void remove(in PendingIntent operation);
}
//5개의 메소드가 선언되어있음
```

  서비스 스텁 클래스는 Binder 클래스의 onTransact() 메서드를 재정의하여 시스템의 바인더 RPC 기능을 추가하므로 알람 매니저 서비스의 서비스 스텁 클래스도 onTransact() 메서드를 재정의하여 IAlarmManager 인터페이스에 정의된 5개의 메서드 관련 코드를 추가했다.

```
//AlarmManagerService.java
class AlarmManagerService extends IAlarmManager.Stub {
   private final Context mContext;

   public AlarmManagerService(Context context) {
      mContext = context;
   }

   public void set(int type, long triggerAtTime, in pendingIntent operation) {
      setRepeating(type, triggerAtTime, 0, operation);
   }
}
```
  AlarmManagerService 클래스는 서비스 인터페이스의 set() 메서드를 재정의하여 실질적인 기능을 구현하고 있다.

- 알람 매니저 서비스 사용

  시스템 서비스를 사용하려면 SDK의 getSystemService() 메서드를 이용해야 한다. 알람 매니저 서비스는 Context 클래스의 ALARM_SERVICE 변수를 인자로 getSystemService() 메서드를 호출하면 애플리케이션을 사용할 수 있고 ContextImpI 클래스의 getAlarmManager() 메서드에서 이를 구현하고 있다.

```
//ContextImpI.java
private AlarmManager getAlarmManager() {
   synchronized (sSync) {
      if (sAlarmManager == null) {
         IBinder b = serviceManager.getService(ALARM_SERVICE);
         IAlarmManager service = IAlarmManager.Stub.asInterface(b);
         sAlarmManager = new AlarmManager(service);
      }
   }
   return sAlarmManager;
}
```

1. ServiceManager의 getService() 메서드로 서비스를 요청하면 알람 매니저 서비스를 가리키는 BinderProxy 객체를 반환받는다
2. asInterface() 메서드를 이용해 Stub.Proxy 서비스 프록시 클래스의 객체를 획득한다.
3. AlarmManager의 인스턴스를 생성하여 반환한다.

10.3.2 HelloWorldService 시스템의 서비스의 구현

- HelloWorldService 설계

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/58284201-0bc5b580-7de5-11e9-9f95-7300c70d52d6.jpg">
</div>

- HelloWorldService 구현

- 서비스 인터페이스, 서비스 프록시, 서비스 스텁의 자동 구현

```
//HelloWorld.aidl
package android.app;

interface IHelloWorld{
   void printHello();
}
```
1. IAlarmManager.aidl 파일이 위치한 경로에 위치시킨다. 
> frameworks/base/core/java/android/app/IAlarmManager.aidl

2. IHelloWorld.aidl 파일이 컴파일 될 수 있게 Android.mk 설정파일을 수정해야한다.
> frameworks/base/Android.mk 파일의 LOCAL_SRC_FILES 항목에서 IAlarmManager.aidl 밑에 IHelloworld.aidl을 추가하면 SDK를 변경하게 된다.

- HelloWorldService 서비스의 구현

  서비스는 서비스 스텁 클래스를 상속받아 구현하면 된다. AIDL 컴파일러에 의해 자동으로 생성된 IHelloWorld.Stub 서비스 스텁 클래스를 상속 받아 구현한다.
> HelloWorldService extends IHelloWorld.stub

- HelloWorldService 서비스의 등록

  자바 시스템 서비스는 ServerThread 클래스의 run() 메서드에서 생성하여 안드로이드 플랫폼에 등록한다. HelloWorldService 시스템 서비스도 run() 메서드에서 HelloWorldService의 인스턴스를 생성하고 자바 서비스 매니저의 addService() 메서드를 통해 시스템에 등록한다.


> ServiceManager.addService(Context.HELLO_SERVICE, helloWorldService);

이후 Context.java 에 HELLO_SERVICE 문자열 상수를 추가한다
> public static final String HELLO_SERVICE = “helloworld”;

10.3.3 HelloWorldService 시스템 서비스의 이용

- HelloWorldManager 구현

```
//HelloWorldManager.java

package android.app;
import android.os.RemoteException;

public class HelloWorldManager
{
   private final IHelloWorld mService;

   HelloWorldManager(IHelloWorld service) {
      mService = service;
   }// HelloWorldManager 클래스의 생성자는 IHelloWorld.Stub.Proxy 클래스의 인스턴스를 인자로 전달 받는다. HelloworldManager 클래스는 android.app 패키지에 포함된 클래스에서는 생성할 수 있으나 SDK를 이용하는 개발자가 임의로 생성할 수는 없다.

   public void printHello() {
      try {
         mService.printHello();
      } catch (RemoteException ex) {
      }
   }// 이 메서드는 RemoteException을 던지므로 호출 시 try/catch 문으로 감싸줘야 한다.
}
```
> RemoteException : 바인더 RPC 중에 발생하는 예외로 호출한 서비스가 존재하지 않을 경우 발생함

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/58284202-0bc5b580-7de5-11e9-9896-055439a41d05.jpg">
</div>


HelloWorldService를 이용하기 위해서 getSystemService() 메서드를 Context.HELLO_SERVICE 인자값과 함께 호출한 후, 반환값을 HelloWorldManager 타입으로 형변환하면 HelloWorldService 서비스를 이용할 수 있다.

```
HelloWorldManager hello = (HelloWorldManager)getSystemService(Context.HELLO_SERVICE);
```

10.3.4 HelloWorldService 시스템 서비스 빌드

  안드로이드 플랫폼은 SDK가 변경되면 경고 메시지를 출력한다. 경고 메시지는 새로 추가된 클래스가 SDK API를 변경하게 되므로 @hide 주석을 추가하거나 current.xml 파일을 make update-api 명령어를 통해 갱신하라고 알려준다.

  make update-api 명령어를 통해 API 정보를 갱신 후 변경된 API 정보는 current.xml 파일에서 확인할 수 있다.

  컴파일이 정상적으로 끝나면 system.img 파일이 생성된다. 생성된 파일을 <ANDROID_SDK> /platforms/android-8/images에 복사한다
  에뮬레이터를 실행하여 HelloWorldManager를 통해 HelloWorldService를 이용하는 애플리케이션을 작성 후 printHello() 메서드를 호출하면 Hello, World 라는 메시지를 확인할 수 있다.

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/58284203-0c5e4c00-7de5-11e9-9719-e33b3edffd16.jpg">
</div>

  HelloWorldService 시스템 서비스가 정상적으로 등록되어 동작하는지 확인하려면 adb shell 명령어를 입력한 후 셸 프롬프트가 출력되면 service list 명령어를 입력한다.


[Sensormanager.java 코드][blog-docs]

[blog-docs]: http://androidxref.com/6.0.1_r10/xref/frameworks/base/core/java/android/hardware/SensorManager.java
