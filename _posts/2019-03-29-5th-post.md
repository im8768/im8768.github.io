4.1 안드로이드와 JNI

4.1.1 왜 안드로이드에서 JNI를 알아야 하는가?



안드로이드 프레임워크는 자바와 C/C++ 기반 모듈이 계층별로 구성돼 있고 각 레어의 계층 별 모듈 대부분은 서로 밀접하게 연관돼 있음. 이렇게 각 계층이 서로 유기적으로 동작하게 만들려면 이를 상호 연결해주는 매개체가 필요하고 각 모듈 간의 인터페이스를 가능하게 해주는 것이 바로 JNI임
<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/55182573-581fbb00-51d1-11e9-8219-d5132f5699ca.jpg">
</div>
```
* JNI의 일반적인 활용

1. 빠른 처리 속도를 요구하는 루틴 작성
2. 하드웨어 제어
3. 기존  C/C++ 프로그램의 재사용
```

4.2 JNI의 기본 원리 이해
4.2.1 자바에서 C 라이브러리 함수 호출하기

1단계 : 자바 코드 작성
- 자바 코드에서 JNI를 통해 C로 구현된 함수를 호출하려면 단순히 자바 클래스에 네이티브 메서드를 선언하면 됨
네이티브 메서드 : 자바 메서드지만 자바가 아닌 C/C++ 같은 네이티브 언어로 작성된 함수


2단계 : 작성한 자바 코드 컴파일
- 1단계에 작성한 코드를 컴파일한다. 
- JDK가 설치되어 있어야함

.java 소스를 컴파일하면 .class 파일이 생성되는데 이 상태에서 실행해도 자바 코드에서 실행할 `.dll` 파일을 만들지 않아서 오류가 생김

3단계 : C/C++ 헤더 파일 생성

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/55182570-57872480-51d1-11e9-9213-42ffac857b34.jpg">
</div>


위 사진처럼 호출할 경우 UnsatisfiedLinkError가 발생함. 이는 자바 가상 머신이 네이티브 키워드로 선언된 메서드와 연결된 JNI 네이티브 코드를 찾아낼 수 없을 때 발생하는 오류

이를 해결하기 위해선 JNI 명세에서 정한 대로 함수 원형을 작성해주면 됨

javah 라는 툴을 활용하면 되는데 사용 방법은 다음과 같음
`javah <native로 선언된 메서드를 포함ᄒᆞᆫ 자바 클래스 이름>`
그럼 javah에 의해 .h 파일이 생성되게 되고 이 파일에는 네이티브 메서드에 대한 C함수의 원형이 들어가게 됨

javah에 의해 생성된 헤더 파일의 함수 이름을 살펴보면 약간 규칙적인 모습으로 정의돼 있음

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/55182571-57872480-51d1-11e9-85c3-4f52abf6dce5.jpg">
</div>

생성된 함수 원형에는 첫 번째와 두 번째 매개변수로 JNIEnv와 jobject 라는 디폴트 매개변수가 포함됨.
세 번째 매개변수부터는 네이티브 메서드가 가지는 매개변수 타입과 비슷한 형태로 C 함수의 매개변수가 각각 생성됨

printHello() -> void Java_HelloJNI_printHello(JNIEnv *, jobject)
printString(String str) -> Java_HelloJNI_printString(JNIEnv *, jobject, jstring)

```
JNIEnv : JNI 인터페이스 포인터로 JNI 명세에 포함된 다양한 JNI 함수를 호출할 수 있음
JNI함수 : JNI 네이티브 함수에서 자바의 객체를 생성하거나 메서드를 호출하는 등의 일을 할수 있게 JNI에서 기본적으로 제공하는 함수 모음
jobject : JNI에서 제공되는 자바 네이티브 타입이며 C 코드에서 자바 객체에 접근할 때 쓰임
```

4단계 : C/C++ 코드 구현

3단계에서 생성된 HelloJNI.h 헤더 파일에서 정의된 함수 원형을 hellojni.c에 복사하는데 javah로 생성된 헤더 파일에서 함수 선언은 매개변수의 타입만 지정돼 있을 뿐 실제로 사용될 매개변수의 이름은 정의돼 있지 않다는 점을 유의해야함

`Java_HelloJNI_printHello(JNIEnv *env, jobject obj) // 매개변수 이름 env, obj추가 `

5단계 : C 공유 라이브러리 생성
6단계 : 자바 프로그램 실행
