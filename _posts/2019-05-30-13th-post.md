11. 자바 시스템 서비스 동작 분석

11.1 액티비티 매니저 서비스

  액티비티 매니저 서비스는 자바 시스템 서비스의 일종인 코어 플랫폼 서비스로서 안드로이드 어플리케이션 컴포넌트인 액티비티, 서비스, 브로드캐스트 리시버 등을 생성하고, 이들의 생명주기를 관리하는 역할을 한다.

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/58640599-65256b80-8334-11e9-961a-e69d286d5b1c.jpg">
</div>

11.2 액티비티 매니저 서비스를 통한 서비스 생성 코드 분석

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/58640600-65be0200-8334-11e9-91e7-9cf3989af94f.jpg">
</div>

11.2.1 Controller 액티비티 – startService() 메서드 호출


```
// Start Service 버튼을 누를 경우(RemoteService.java)

private OnClickListener mStartListener = new onClickListener() {
   public void onClick(View v) {
      startService(new Intent(“com.example.android.apis.app.REMOTE_SERVICE”));
   }
};
```

11.2.2 액티비티 매니저 서비스의 startService() 메서드 호출 과정

  startService() API의 실제 구현은 액티비티 매니저 서비스에 속한, 동일한 이름을 가진 startService() 스텁 메서드에 들어 있다. 
  즉, 액티비티에서 호출한 startService() API는 자바 서비스 프레임워크 기반에서 바인더 RPC 형태로 액티비티 매니저 서비스에서 제공하는 startService() 스텁 메서드를 호출하게 되는 것이다.

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/58640601-65be0200-8334-11e9-8706-c1bfdd653ff1.jpg">
</div>

1) Controller 액티비티
   a) ContextWrapper 클래스 – ContextImpI 객체의 startService() 메서드 호출
   b) ContextImpI 클래스 – startService() 메서드 처리

2) ActivityManagerProxy 객체 – startService() 프록시 메서드 처리
3) ActivityManagerNative 객체 – startService() 스텁 메서드 호출


11.2.3 액티비티 매니저 서비스 – startService() 스텁 메서드 실행

```
//ActivityManagerService 클래스의 startService() 메서드
public ComponentName startService(IApplicationThread caller, Intent service, String resolvedType){
   final int callingPid = Binder.getCallingPid();
   final int callingUid = Binder.getCallingUid();

   Component res = startServiceLocked(caller, service, resolvedType, callingPid, callingUid);

return res;
}
```
> 첫 인자에 전달되는 caller, 이 객체는 액티비티 서비스가 IApplicationThread 서비스 인터페이스 기반의 RPC를 통해 Controller 액티비티를 제어할 수 있도록 생성됨
> 그 다음으로는 service 인자를 비롯한 서비스 생성을 요청한 프로세스의 pid uid 값을 추가로 전달함

  startServiceLocked() 메서드의 주요 역할은 실행할 서비스와 관련된 ServiceRecord 값을 얻는 것이다. ServiceRecord는 안드로이드 애플리케이션 서비스에 대한 각종 정보가 담긴 클래스이다. startServiceLocked() 메서드는 retrieveServiceLocked() 메서드에 인텐트를 전달해서 서비스에서 대한 정보를 얻는다. 

  이렇게 구한 ServiceRecord 객체를 bringUpServiceLocked() 메서드의 첫 번째 인자로 전달한다. bringUpServiceLocked() 메서드는 우선 인자로 전달된 ServiceRecord 객체를 참조해서 해당 서비스가 실행될 프로세스 이름과 uid를 통해 ProcessRecord 객체가 이미 존재하는지 검색하고 이를 위해 getProcessRecordLocked() 메서드가 호출된다.

  ProcessRecord는 현재 동작 중인 특정 프로세스에 관한 대부분의 정보를 포함하고 있는 클래스다.



11.2.4 ActivityThread 클래스의 main() 메서드 실행

  Zygote는 특정 자바 클래스의 실행을 요청받으면 새로운 프로세스를 생성하고 그 위에 해당 클래스를 로드한 후 해당 클래스의 main() 메서드를 호출한다. 따라서 ActivityThread 실행을 요청받은 Zygote는 새로 생성한 프로세스의 ActivityThread 클래스를 로드한 다음, ActivityThread 클래스의 main() 메서드를 호출한다.

  main() 메서드의 주요부분을 살펴보면 우선 동일한 프로세스 내의 스레드 간 메시지 통신을 위해 Looper.prepareMainLooper() 메서드를 이용해서 메시지 큐를 생성한다. 메시지 큐를 생성한 다음 ActivityThread 객체를 생성한다.
  이 객체는 액티비티 매니저 서비스와의 상호 작용을 통해 안드로이드 애플리케이션 프로세스의 메인 스레드 실행 및 액티비티 스케줄링 등을 수행한다.


<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/58640602-65be0200-8334-11e9-9a3d-83722a3bfd21.jpg">
</div>

1. ActivityThread – ActivityManagerProxy 객체의 attachApplication() 프록시 메서드 호출
2. ActivityManagerProxy 객체 – ActivityManagerNative 객체에 ATTACH_APPLICATION_TRANSACTION RPC 코드와 바인더 RPC 데이터를 전송
3. ActivityManagerNative 객체 – ActivityManagerService에 포함된 attachApplication() 스텁 메서드를 호출

11.2.5 액티비티 매니저 서비스 – attachApplication() 스텁 메서드 처리

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/58640603-66569880-8334-11e9-8b61-84c309f8552c.jpg">
</div>

  액티비티 매니저 서비스가 바인더 RPC를 통해 ActivityThread에게 생성할 서비스 정보를 넘겨 실제 RemoteService를 실행하는 과정을 보여준다.

이 과정은 액티비티 서비스의 IApplicationThread 서비스 인터페이스에 기반을 둔 attachApplication() 프록시 메서드 호출을 시작으로 크게 5단게로 진행된다.

1. 액티비티 매니저 서비스 
  ActivityManagerProxy 객체의 scheduleCreateService() 프록시 메서드 호출

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/58640604-66569880-8334-11e9-9152-55d4dbf88ec0.jpg">
</div>

  액티비티 매니저 서비스는 pid를 이용해서 mPidsSelfLocked 해시에서 ProcessRecord 객체를 구한 다음 이 객체의 Thread 멤버 변수를 통해 두 번째 인자로 넘어온 pid를 가지는 ActivityThread와 연결되는 ApplicationThreadProxy 객체를 구할 수가 있다.

2. ActivityManagerProxy 객체
  ActivityThread의 ActivityManagerNative 객체에 SCHEDULE_CREATE_SERVICE_TRANSACTION RPC 코드와 바인더 RPC 데이터 전송
  
3. ActivityManagerNative 객체
  ApplicationCreateService의 ApplicationThread 객체에 포함된 scheduleCreateService() 스텁 메서드 호출

4. ApplicationThread 객체
  ApplicationCreateService의 ActivityThread에 메시지큐를 이용해 CREATE_SERVICE 메시지 전달

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/58640605-66569880-8334-11e9-8960-e43508d7eaf6.jpg">
</div>

  scheduleCreateService() 스텁 메서드는 내부적으로 특정한 기능이 없이 인자로 전달된 ServiceRecord와 ServiceInfo 객체를 이용해 CreateServiceData라는 객체를 만든 다음 이를 ActivityThread 메시지 큐에 CREATE_SERVICE 메시지로 전달한다.

5. ActivityThread 객체
  RemoteService 서비스 생성 및 서비스 생명주기에 따른 onCreate() 호출

11.3 정리

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/58640607-66569880-8334-11e9-98eb-5a56e9f67727.jpg">
</div>

1) Controller 액티비티는 RemoteService 서비스를 실행하기 위해 startService() API를 통해 액티비티 매니저 서비스에 RemoteService 서비스 실행을 요청한다.

2) 요청받은 서비스가 리모트 서비스인 경우 액티비티 매니저 서비스는 Zygote에게 서비스를 별도의 독립 프로세스로 실행시키기 위해 ActivityThread 생성을 요청한다.

3) Zygote에 의해 생성된 ActivityThread는 attachApplication() 프록시 메서드를 통해 액티비티 매니저 서비스에게 자신을 등록한다.

4) 액티비티 매니저 서비스는 1)에게 요청받은 RemoteService 생성을 ActivityThread에 요청한다.

5) ActivityThread는 요청했던 RemoteService 서비스의 인스턴스를 생성한 다음 이 서비스의 onCreate() 콜백 함수를 호출한다.
