7. 안드로이드 바인더 IPC

바인더는 원래 IPC 도구이지만 안드로이드에서는 다른 프로세스에 있는 함수를 마치 현재 프로세스에 존재하는 함수처럼 사용할 수 있게 해주는 RPC를 지원하는 데 주로 이용된다.

7.1 리눅스 메모리 공간과 바인더 드라이버

안드로이드의 프로세스는 프로세스만의 고유한 가상 주소 공간에서 실행된다. 가상 주소 공간은 3GB의 사용자 공간과 1GB의 커널 공간으로 나뉜다.

> 사용자 코드 관련 라이브러리 : 사용자 공간의 코드, 데이터, 스택 영역에서 동작
> 커널 공간에서 동작해야할 코드 : 커널 공간의 각 영역에서 동작

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/57876965-9e001380-7851-11e9-8026-a4853cc046dd.jpg">
</div>

독립된 공간을 가진 프로세스가 다른 프로세스에게 데이터를 전달하려면 프로세스간 공유가 가능한 커널 공간을 이용해야한다.

> 예시 : 휴대폰 카메라에서 화면출력 프로세스로 화면출력 요청을 할 때

 안드로이드는 리눅스와 달리 단순히 메시지를 전달하는 IPC 개념이 아니라 상대 프로세스에 존재하는 함수까지 호출할 수 있는 바인더라는 IPC 도구를 채택해 프로세스 간 RPC를 지원

* 안드로이드에서 바인더 드라이버를 추가해서 프로세스 간 통신을 수행하는 이유

> 리눅스의 뛰어난 메모리 관리 기법을 그대로 채용하여 커널 공간을 통한 데이터 전달 시 신뢰성을 확보할 수 있음
> 사용자가 접근할 수 없는 커널 공간을 통해 데이터를 주고 받으므로 IPC 간의 보안 문제도 해결

7.2 안드로이드 바인더 모델

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/57876966-9e001380-7851-11e9-85a1-096f75c531d4.jpg">
</div>

> 서비스 클라이언트는 IPC를 통해 서비스 서버의 foo() 함수를 호출하는 것과 같은 효과를 내기위해 바인더 IPC 데이터를 서비스 서버로 전달

> 바인더 드라이버는 foo() 함수를 호출하기 위한 바인더 IPC 데이터를 서비스 클라이언트에서 서비스 서버로 전달하는 역할



IPC 데이터는 함수 호출과 관련된 내용, 즉 사용하고자 하는 서비스 번호와 호출할 함수명, 바인더 프로토콜로 구성된다. 

> 서비스 번호 : 안드로이드에서 동작 중인 여러 서비스를 구분
> 함수명 : 서비스 서버에서 동작하는 여러 서비스 가운데 서비스 클라이언트가 호출할 함수를 찾기 위함
> 바인더 프로토콜 : 바인더 드라이버와 바인더를 이용하는 프로세스 간의 IPC 데이터를 처리하는 규약

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/57876967-9e98aa00-7851-11e9-9837-6f0a96f963ec.jpg">
</div>

> 핸들 : 서비스를 구별하는 번호
- 바인더 드라이버는 핸들 값을 통해 어떤 서비스에 바인더 IPC 데이터를 전달해야 하는지 결정한다.

> RPC 코드 / RPC 데이터 : 서비스에서 호출할 함수와 함수의 인자
- RPC 코드는 서비스에 포함된 함수 중 어느 함수에 데이터를 전달할지를 나타내고 RPC 데이터는 RPC 코드가 가리키는 함수에 전달 인자 값을 의미한다.

7.2.1 바인더 IPC 데이터의 전달

바인더 드라이버는 open() 이나 ioctl() 같은 시스템 콜을 통해 접근 가능하다.

1. 바인더를 통해 RPC를 시도하는 애플리케이션은 open() 시스템 콜을 통해 바인더 드라이버의 파일 디스크립터를 얻음
2. mmap() 시스템 콜을 통해 커널 내에서 IPC 데이터를 수신하기 위한 공유 공간을 확보
3. ioctl() 함수의 인자로 바인더 드라이버에 IPC 데이터를 전달

* ioctl() 함수의 첫 번째 인자는 바인더 드라이버를 OPEN할 때 반환되는 파일 디스크립터
* 두 번째 인자는 ioctl 명령어
* 세 번째 인자는 ioctl 명령어의 종류에 따라 달라짐

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/57876969-9e98aa00-7851-11e9-8969-cb0588657ad9.jpg">
</div>


> 이번 장에서 주로 다룬 IPC 데이터 전달은 BINDER_WRITE_READ ioctl 명령어 사용


7.2.2 바인더 IPC 데이터의 흐름

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/57876971-9e98aa00-7851-11e9-944d-2bc09f293c1b.jpg">
</div>

> 서비스 계층 : 특정 기능을 수행하는 함수가 존재하는 계층
- 서비스 클라이언트는 이 계층에서 사용하고자 하는 서비스의 함수를 가상으로 호출
- 서비스 서버는 서비스 클라이언트가 요청한 서비스 함수를 실제로 호출

> RPC 계층
- 서비스 클라이언트는 이 계층에서 서비스의 함수를 호출하기 위한 RPC 코드와 RPC 데이터를 생성
- 서비스 서버는 전달받은 RPC 코드를 토대로 함수를 찾고 RPC 데이터 전달

> IPC 계층 : RPC 계층에서 만든 RPC 코드와 RPC 데이터를 바인더 드라이버에 전달하기 위한 바인더 IPC 데이터로 캡슐화 하는 역할

> 바인더 드라이버 계층 : IPC 계층으로부터 전달받은 바인더 IPC 데이터 통해 서비스를 가진 서비스 서버를 찾은 후 IPC 데이터 전달

7.2.3 바인더 프로토콜

바인더 프로토콜은 바인더 IPC 데이터에 포함되어 IPC 계층에서 바인더 드라이버로 전달되거나 바인더 드라이버에서 IPC 계층으로 전달되며 전달 방향에 따라 두가지로 분류된다.

1. 바인더 프로토콜이 IPC 계층에서 바인더 드라이버로 전송될 때 - `BINDER COMMAND PROTOCOL` / 접미사로 BC_를 가짐

2. 바인더 드라이버에서 IPC 계층으로 전달될 때 - `BINDER RETURN PROTOCOL` / 접미사로 BR_을 가짐

바인더 IPC를 이용하는 프로세스와 바인더 드라이버는 헤더 파일(kernel/drivers/staging/android/binder.h)에 바인더 프로토콜을 정의하고 있다.

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/57876972-9e98aa00-7851-11e9-8291-6715949f2c0b.jpg">
</div> 

1. 서비스 클라이언트는 BC_TRANSACTION 프로토콜을 통해 바인더 드라이버에 IPC 데이터 전달을 명령
2. 바인더 드라이버는 전달받은 IPC 데이터를 토대로 바인더 프로토콜이 BC_TRANSACTION이면 IPC 데이터의 핸들을 통해 서비스 서버를 찾음
3. 바인더 드라이버는 바인더 프로토콜을 BR_TRANSACTION으로 변경하고 이를 IPC 데이터에 실어서 서비스 서버로 전달
4. 서비스 서버는 전달받은 바인더 프로토콜이 BR_TRANSACTION인지 체크한 후 IPC 데이터를 분석해서 서비스 사용자가 요청한 함수를 호출

7.2.5 바인더 어드레싱

안드로이드에는 다양한 서비를 목록화해서 관리하는 컨텍스트 매니저라는 특별한 프로세스가 있다. 컨텍스트 매니저는 서비스마다 핸들이라는 번호 값을 할당하고 서비스의 추가/검색 등의 관리 기능을 수행한다.

> 바인더 어드레싱 : 바인더 드라이버가 IPC 데이터의 핸들을 가지고 서비스 서버를 찾는 과정

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/57876975-9f314080-7851-11e9-8b2f-8c3b210a7763.jpg">
</div>

바인더 어드레싱을 위해서 서비스 서버는 자신이 가진 서비스에 대한 접근 정보를 컨텍스트 매니저에 등록해야 한다. 

* 서비스 클라이언트가 서비스를 등록하는 과정

0. 서비스 서버는 ADD_SERVICE라는 RPC 코드와 등록할 서비스 이름(RPC 데이터) 핸들을 0으로 지정한 IPC 데이터를 바인더 드라이버에 전달한다.

1. 바인더 드라이버는 핸들 0에 해당하는 바인더 노드를 찾음
- 핸들 0에 해당하는 바인더 노드는 컨텍스트 매니저를 의미하기 때문에 서비스 서버는 IPC 데이터를 컨텍스트 매니저에 전달

2. 바인더 드라이버는 서비스 서버의 서비스 A에 해당하는 바인더 노드를 하나 생성

3. 컨텍스트 매니저가 생성된 바인더 노드를 알 수 있게 바인더 노드 참조 데이터를 생성해 해당 노드를 연결
- 참조 데이터는 생성된 순서대로 번호가 매겨지고 이 번호는 IPC 데이터에 담겨 컨텍스트 매니저로 전달

서비스 등록 과정은 안드로이드 부팅 단계에서 끝난다. 서비스 등록이 끝나면 컨텍스트 매니저의 서비스 목록, 바인더 드라이버의 바인더 노드, 서비스 서버들의 서비스가 연결된다.

* 서비스 클라이언트가 서비스를 검색하는 과정

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/57876976-9f314080-7851-11e9-913d-afcc78695e87.jpg">
</div>

0. 서비스 클라이언트는 GET_SERVICE라는 RPC코드와 요청할 서비스 이름(RPC 데이터), 그리고 핸들을 0으로 지정한 IPC 데이터를 바인더에 전달

1. IPC 데이터를 전달받은 컨텍스트 매니저는 자신의 서비스 목록에서 서비스 이름에 해당하는 서비스 번호를 찾은 다음 이를 바인더 드라이버에 전달

2. 바인더 드라이버는 전달되 데이터에서 서비스 목록 번호에 해당하는 참조 데이터를 찾고 서비스 클라이언트 쪽에 서비스 클라이언트 쪽에 참조 데이터를 생성해 컨텍스트 매니저의 참조 데이터가 가리키는 바인더 노드를 연결
- 연결된 바인더 노드는 서비스 서버가 자신의 서비스를 위해 생성했던 바인더 노드에 해당

3. 바인더 드라이버는 생성한 참조 데이터를 생성된 순서대로 번호를 매겨 서비스 클라이언트에 알려줌
- 서비스 클라이언트는 이 번호를 핸들로 지정하여 서비스 서버의 바인더 노드를 찾음 

4. 서비스 클라이언트는 이전 단계에서 전달받은 참조 데이터의 번호를 핸들에 저장하고 사용할 서비스의 함수에 해당하는 RPC 코드와 RPC 데이터를 IPC 데이터에 담아 서비스 서버로 전달하여 서비스 A가 가진 함수를 호출

* 서비스 클라이언트가 서비스를 사용하는 과정

<div>
<img width="100%" src="https://user-images.githubusercontent.com/34255526/57876977-9f314080-7851-11e9-99a5-1a3bfc12fbc5.jpg">
</div>

서비스 서버는 IPC 데이터를 수신한 후 RPC 코드와 RPC 데이터에 따른 처리를 함


